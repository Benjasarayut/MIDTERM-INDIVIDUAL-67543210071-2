<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-content">
            <h1>
                <i class="fas fa-book-open" style="color:#6366f1;"></i> Library System
            </h1>
            <div class="badge-arch">
                <i class="fas fa-layer-group"></i> Layered Architecture
            </div>
        </div>
        
        <button class="theme-toggle" onclick="toggleTheme()" title="Switch Theme">
            <i class="fas fa-moon" id="themeIcon"></i>
        </button>
    </div>

    <div class="controls">
        <button class="btn-add" onclick="openModal()">
            <i class="fas fa-plus"></i> Add New Book
        </button>

        <div class="filters">
            <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
            <button class="filter-btn" onclick="setFilter('available', this)">Available</button>
            <button class="filter-btn" onclick="setFilter('borrowed', this)">Borrowed</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card card-1" onclick="triggerFilter('available')">
            <div class="stat-num" id="statAvailable">0</div>
            <div class="stat-label">Available</div>
        </div>
        <div class="stat-card card-2" onclick="triggerFilter('borrowed')">
            <div class="stat-num" id="statBorrowed">0</div>
            <div class="stat-label">Borrowed</div>
        </div>
        <div class="stat-card card-3" onclick="triggerFilter('all')">
            <div class="stat-num" id="statTotal">0</div>
            <div class="stat-label">Total Books</div>
        </div>
    </div>

    <div id="bookList" class="book-list"></div>
</div>

<div id="bookModal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="modalTitle">Add New Book</h2>
        <input type="hidden" id="editBookId">
        
        <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" id="title" placeholder="e.g. Clean Code">
        </div>
        <div class="form-group">
            <label class="form-label">Author</label>
            <input type="text" class="form-input" id="author" placeholder="e.g. Robert C. Martin">
        </div>
        <div class="form-group">
            <label class="form-label">ISBN</label>
            <input type="text" class="form-input" id="isbn" placeholder="e.g. 9780132350884">
        </div>

        <div class="modal-btns">
            <button class="btn" style="background:#64748b; color:white;" onclick="closeModal()">Cancel</button>
            <button class="btn" style="background:#6366f1; color:white;" onclick="submitBook()">Save</button>
        </div>
    </div>
</div>

<script>
    let books = [];
    let currentFilter = 'all';

    // --- Start App & Check Theme ---
    window.onload = () => {
        fetchBooks();
        loadTheme(); // โหลดธีมที่เคยบันทึกไว้
    };

    // --- Theme Logic ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        
        // Update Icon
        const icon = document.getElementById('themeIcon');
        icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        
        // Save to LocalStorage
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        const icon = document.getElementById('themeIcon');
        
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            icon.className = 'fas fa-sun'; // ถ้ามืดอยู่ ให้โชว์ไอคอนพระอาทิตย์
        } else {
            icon.className = 'fas fa-moon'; // ถ้าสว่างอยู่ ให้โชว์ไอคอนพระจันทร์
        }
    }

    // --- Main Logic (เหมือนเดิม) ---
    async function fetchBooks() {
        try {
            const res = await fetch('/api/books');
            const data = await res.json();
            books = data.books || [];
            updateStats(data.statistics);
            renderBooks();
        } catch (error) { console.error(error); }
    }

    function renderBooks() {
        const container = document.getElementById('bookList');
        container.innerHTML = '';
        const filtered = books.filter(b => currentFilter === 'all' || b.status === currentFilter);
        
        if(filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:var(--text-muted);">No books found.</p>';
            return;
        }

        filtered.forEach(book => {
            const isBorrowed = book.status === 'borrowed';
            const badge = isBorrowed 
                ? `<span class="status-badge bg-borrow"><i class="fas fa-times-circle"></i> BORROWED</span>`
                : `<span class="status-badge bg-avail"><i class="fas fa-check-circle"></i> AVAILABLE</span>`;
            const actionBtn = isBorrowed
                ? `<button class="btn btn-return" onclick="returnBook(${book.id})">Return</button>`
                : `<button class="btn btn-borrow" onclick="borrowBook(${book.id})">Borrow</button>`;

            container.innerHTML += `
                <div class="book-card">
                    <div class="book-title">${book.title}</div>
                    <div class="book-meta">
                        <div><i class="fas fa-user"></i> ${book.author}</div>
                        <div><i class="fas fa-tag"></i> ISBN: ${book.isbn}</div>
                    </div>
                    ${badge}
                    <div class="card-actions">
                        ${actionBtn}
                        <button class="btn btn-edit" onclick="openEditModal(${book.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteBook(${book.id})">Delete</button>
                    </div>
                </div>`;
        });
    }

    function updateStats(stats) {
        if (!stats) return;
        document.getElementById('statAvailable').innerText = stats.available;
        document.getElementById('statBorrowed').innerText = stats.borrowed;
        document.getElementById('statTotal').innerText = stats.total;
    }

    async function submitBook() {
        const id = document.getElementById('editBookId').value;
        const body = JSON.stringify({
            title: document.getElementById('title').value,
            author: document.getElementById('author').value,
            isbn: document.getElementById('isbn').value
        });
        
        try {
            const res = await fetch(id ? `/api/books/${id}` : '/api/books', {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body
            });
            if (!res.ok) throw new Error((await res.json()).error);
            closeModal(); fetchBooks();
        } catch (err) { alert(err.message); }
    }

    async function borrowBook(id) { apiAction(`/api/books/${id}/borrow`, 'PATCH'); }
    async function returnBook(id) { apiAction(`/api/books/${id}/return`, 'PATCH'); }
    async function deleteBook(id) { if(confirm('Delete?')) apiAction(`/api/books/${id}`, 'DELETE'); }

    async function apiAction(url, method) {
        try {
            const res = await fetch(url, { method });
            if (!res.ok) throw new Error((await res.json()).error);
            fetchBooks();
        } catch (err) { alert(err.message); }
    }

    function setFilter(filter, btn) {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderBooks();
    }

    function triggerFilter(status) {
        const btnIndexMap = { 'all': 0, 'available': 1, 'borrowed': 2 };
        const buttons = document.querySelectorAll('.filter-btn');
        if (buttons[btnIndexMap[status]]) {
            setFilter(status, buttons[btnIndexMap[status]]);
        }
    }

    function openModal() {
        document.getElementById('editBookId').value = '';
        document.getElementById('title').value = '';
        document.getElementById('author').value = '';
        document.getElementById('isbn').value = '';
        document.getElementById('modalTitle').innerText = 'Add New Book';
        document.getElementById('bookModal').classList.add('active');
    }
    function openEditModal(id) {
        const book = books.find(b => b.id === id);
        if(!book) return;
        document.getElementById('editBookId').value = book.id;
        document.getElementById('title').value = book.title;
        document.getElementById('author').value = book.author;
        document.getElementById('isbn').value = book.isbn;
        document.getElementById('modalTitle').innerText = 'Edit Book';
        document.getElementById('bookModal').classList.add('active');
    }
    function closeModal() { document.getElementById('bookModal').classList.remove('active'); }
</script>

</body>
</html>